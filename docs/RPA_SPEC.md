# EasyApo予約システム RPA仕様書

> **バージョン**: 1.0
> **作成日**: 2026-01-13
> **対象システム**: EasyApo (CI Medical)

## 概要

EasyApo予約管理システムに対するRPA処理の技術仕様書です。Playwrightを使用してブラウザを自動操作し、予約の取得・作成・キャンセル・削除を行います。

### 対象URL
- `https://cieasyapo2.ci-medical.com/`

### システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                      EasyApo 画面構成                        │
├─────────────────┬───────────────────────────────────────────┤
│  SideMain       │              ReserveDay                   │
│  (カレンダー)    │           (予約日コンポーネント)            │
│                 │                                           │
│  - clickDay()   │  - reserve_rows[] (予約一覧)              │
│    日付選択      │  - column_rows[]  (担当者一覧)            │
│        ────────>│  - time_rows[]    (時間枠一覧)            │
│                 │                                           │
└─────────────────┴───────────────────────────────────────────┘
```

---

## 1. ログイン

### 1.1 概要

EasyApoシステムへの認証を行います。VueコンポーネントのAPIを直接操作してログイン処理を実行します。

### 1.2 処理フロー

1. ログインページにアクセス
2. `.login-wrapper`要素からVueコンポーネントを取得
3. `form.login_id`、`form.login_password`に認証情報を設定
4. `execLogin()`メソッドを実行
5. `/login` APIのレスポンスを監視
6. HTTPステータスが200以外の場合、`AuthError`をスロー

### 1.3 Vueコンポーネントの検索方法

Vueコンポーネントは`$vnode.tag`プロパティの末尾でコンポーネント名を検索します。DOM構造への依存を減らすため、固定セレクターではなくコンポーネント名で検索します。

```javascript
// コンポーネント検索パターン
const el = Array.from(document.querySelectorAll('*'))
  .find(el => el?.__vue__?.$vnode?.tag?.endsWith('FormLogin'));
const formLogin = el?.__vue__;
```

| コンポーネント名 | 用途 |
|-----------------|------|
| `FormLogin` | ログインフォーム |

### 1.4 使用するAPI

| エンドポイント | メソッド | 用途 |
|---------------|---------|------|
| `/login` | POST | 認証処理 |

### 1.5 Vueコンポーネント: FormLogin

| プロパティ/メソッド | 説明 |
|-------------------|------|
| `form.login_id` | ログインID入力値 |
| `form.login_password` | パスワード入力値 |
| `execLogin()` | ログイン実行メソッド |

### 1.6 エラーレスポンス

認証失敗時のレスポンス例（HTTP 422）:

```json
{
  "result": false,
  "data": null,
  "message": {
    "login_id": [
      "ログインに失敗しました。入力内容をご確認ください"
    ]
  }
}
```

---

## 2. 空き枠の取得

### 2.1 概要

アポイント管理台帳画面から、指定期間内の空き枠情報を取得します。

### 2.2 処理フロー

1. アポイント管理台帳ページに遷移
2. `SideMain.clickDay()`で対象日付を選択
3. `ReserveDay`コンポーネントから以下を取得:
   - `time_rows`: 予約可能な時間枠一覧
   - `column_rows`: 担当者/リソース一覧
   - `reserve_rows`: 既存予約一覧
4. 休憩時間（`is_break_time`）を除外
5. 既存予約と照合して空き枠を算出

### 2.3 Vueコンポーネントの検索

| コンポーネント名 | 用途 |
|-----------------|------|
| `SideMain` | サイドカレンダー（日付選択・患者検索） |
| `ReserveDay` | 予約日コンポーネント（予約一覧・担当者一覧） |

### 2.4 Vueコンポーネント: SideMain

| プロパティ/メソッド | 説明 |
|-------------------|------|
| `clickDay({ id: 'YYYY-MM-DD' })` | 指定日付の予約データを読み込む |
| `selected_date` | 選択されている日付（Date型） |
| `s_q` | 検索クエリ文字列 |
| `clickSearch()` | 患者検索を実行（s_qの値で検索） |

### 2.5 Vueコンポーネント: ReserveDay

| プロパティ/メソッド | 説明 |
|-------------------|------|
| `reserve_rows[]` | 読み込んだ日付の予約情報一覧 |
| `column_rows[]` | 担当者/リソース一覧 |
| `time_rows[]` | 予約可能時間枠一覧 |
| `$store.state.api.get_treatment_items` | 診療メニュー取得APIのURL |
| `get<T>(url, params)` | API通信メソッド（Axiosレスポンス形式） |

### 2.6 データ構造: time_rows（時間枠情報）

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `hour` | 時（2桁文字列） | "09" |
| `minute` | 分（2桁文字列） | "00", "15", "30", "45" |
| `time_text` | 時刻テキスト | "09:00" |
| `time_num` | 時刻数値 | "0900" |
| `top` | 表示位置（ピクセル） | 0, 28, 56... |
| `is_break_time` | 休憩時間フラグ | true/false |
| `is_night_break_time` | 夜間休憩時間フラグ | true/false |

### 2.7 データ構造: column_rows（担当者情報）

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `id` | 担当者ID | 1, 2, 3... |
| `name` | 担当者名 | "Dr1", "DH1", "急患" |

### 2.8 データ構造: reserve_rows（予約情報）

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `id` | 予約ID | 12345678 |
| `patient_id` | 患者ID | 10000001 |
| `patient_number` | 患者番号 | "001" |
| `column_no` | カラム番号（担当者IDと対応） | 1 |
| `reservation_date` | 予約日 | "2026-01-27" |
| `time_from` | 開始時刻 | "09:00" |
| `time_to` | 終了時刻 | "09:30" |
| `patient_name` | 患者名 | "山田 太郎" |
| `treatment_id` | 診療ID | 100001 |
| `color` | 表示色 | "#c6f605" |
| `pic` | 担当者 | null |
| `birthday` | 生年月日 | "1990-01-01" |
| `status` | ステータス | 1 |
| `cancel` | キャンセルフラグ | 0 |
| `block` | ブロックフラグ | 0 |
| `parent_id` | 親予約ID（繰り返し予約の場合） | null |
| `repeat_type` | 繰り返しタイプ | null |
| `repeat_to` | 繰り返し終了日 | null |
| `has_subsequent` | 後続予約があるか | false |

### 2.9 診療メニューの取得

`ReserveDay`コンポーネントの`get()`メソッドを使用して診療メニュー一覧を取得できます。

#### 使用するAPI

| エンドポイント | メソッド | 用途 |
|---------------|---------|------|
| `$store.state.api.get_treatment_items` | GET | 診療メニュー一覧取得 |

#### データ構造: TreatmentItem（診療メニュー）

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `id` | 診療メニューID | 100001 |
| `title` | 診療メニュー名 | "定期検診" |
| `color` | 表示色 | "#c6f605" |
| `treatment_time` | 所要時間（分） | 30 |
| `use_column` | 処置可能な担当者ID一覧 | [1, 2, 3] |
| `pic` | 担当者 | null |
| `order` | 表示順 | 1 |
| `resources` | 処置可能な担当者名一覧（変換後） | ["Dr1", "DH1"] |

---

## 3. 予約の作成

### 3.1 概要

新規予約を作成します。

### 3.2 処理フロー

1. `SideMain.clickDay()`で対象日付を選択
2. 予約フォームを開く
3. 顧客情報を入力
4. 予約を確定

### 3.3 入力情報

| フィールド | 説明 | 形式 |
|-----------|------|------|
| 日付 | 予約日 | YYYY-MM-DD |
| 時刻 | 開始時刻 | HH:MM |
| 担当者 | 担当者ID | 数値 |
| 顧客名 | 患者名 | 文字列 |
| 電話番号 | 連絡先 | 文字列 |

---

## 4. 予約のキャンセル

### 4.1 概要

既存の予約をキャンセルします。予約履歴は残ります。

### 4.2 処理フロー

1. `SideMain.clickDay()`で対象日付を選択
2. `/reservations` APIで対象予約を検索（メモ内の電話番号で特定）
3. `ReserveDay.openReserveEdit()`で予約編集ダイアログを開く
4. 「予約をキャンセル」ボタンをクリック
5. `CancelAdd`コンポーネントの`form`を操作してキャンセル設定
6. `/reservations/:id/cancel` APIでキャンセル実行

### 4.3 Vueコンポーネント: CancelAdd

| プロパティ/メソッド | 説明 |
|-------------------|------|
| `form.circumstance_type` | キャンセル/削除種別（1: キャンセル, 99: 削除） |
| `form.cancel_type` | キャンセル種類（1: TEL, 2: TEL変更, 11: WEB, 99: 無断） |
| `form.cancel_reason` | キャンセル理由 |
| `form.cancel_memo` | キャンセルメモ |

### 4.4 使用するAPI

| エンドポイント | メソッド | 用途 |
|---------------|---------|------|
| `/reservations/:id/cancel` | POST | 予約キャンセル/削除 |

---

## 5. 予約の更新

### 5.1 概要

既存の予約を更新します。メニュー変更、日時変更、担当者変更が可能です。

### 5.2 処理フロー

1. `SideMain.clickDay()`で対象日付を選択
2. `/reservations` APIで対象予約を検索（メモ内の電話番号と時刻で特定）
3. `ReserveDay.openReserveEdit()`で予約編集ダイアログを開く
4. `ReserveEdit`コンポーネントの`is_loaded`を待機
5. `ReserveEdit.form`を操作して予約情報を更新:
   - メニュー変更時: メモ内容と表示色を更新
   - 日時変更時: `reservation_date`、`time_from`、`time_to`を更新
   - 担当者変更時: `column_no`を更新
6. メニュー変更時は担当者の対応可否をチェック（`use_column`で確認）
7. `ReserveEdit.clickExec()`で更新を実行
8. `/reservations/:id` APIのPOSTレスポンスを確認

### 5.3 日時変更の計算

開始時刻を変更する場合、終了時刻は所要時間を維持して自動計算されます。

### 5.4 担当者の自動変更

メニュー変更時、現在の担当者が新しいメニューに対応できない場合：
1. `TreatmentItem.use_column`で対応可能な担当者IDを取得
2. 同一時間帯で空いている対応可能な担当者を検索
3. 見つかった場合は自動的に担当者を変更
4. 見つからない場合はエラーを返却

### 5.5 Vueコンポーネント: ReserveEdit

| プロパティ/メソッド | 説明 |
|-------------------|------|
| `form.reservation_date` | 予約日（YYYY-MM-DD形式） |
| `form.time_from` | 開始時刻（HH:MM形式） |
| `form.time_to` | 終了時刻（HH:MM形式） |
| `form.column_no` | 担当者ID |
| `form.color` | 表示色 |
| `form.memo` | メモ情報の配列 |
| `is_loaded` | 編集データの読み込み完了フラグ |
| `clickExec()` | 更新を実行 |
| `clickClose()` | ダイアログを閉じる |
| `clickReserveCancel()` | キャンセルダイアログを表示 |

### 5.6 使用するAPI

| エンドポイント | メソッド | 用途 |
|---------------|---------|------|
| `/reservations/:id` | POST | 予約更新 |

### 5.7 エラーハンドリング

レスポンスに`confirmation`がある場合（診療時間外など）はエラーとして処理し、ページをリロードしてダイアログを閉じます。

---

## 6. 予約の削除

### 6.1 概要

既存の予約を完全に削除します。キャンセルとは異なり、予約履歴を残しません。

### 6.2 処理フロー

1. `SideMain.clickDay()`で対象日付を選択
2. `/reservations` APIで対象予約を検索（メモ内の電話番号で特定）
3. `ReserveDay.openReserveEdit()`で予約編集ダイアログを開く
4. 「予約をキャンセル」ボタンをクリック
5. `CancelAdd`コンポーネントの`form.circumstance_type`を`99`（削除）に設定
6. `/reservations/:id/cancel` APIで削除実行

---

## 7. 予約の検索

### 7.1 概要

電話番号で予約を検索します。同一電話番号で複数の患者（家族など）がいる場合、すべての患者の予約を返します。

### 7.2 処理フロー

1. `SideMain`の`s_q`に電話番号を設定
2. `SideMain.clickSearch()`で患者検索を実行
3. `/patients?` APIのレスポンスを監視
4. `tel1`または`tel2`が一致する患者をすべて抽出
5. 各患者について`/patients/:id` APIで予約履歴を取得
6. 日付範囲でフィルタ
7. 各予約について`/reservations/:id` APIで詳細を取得
8. キャンセル済み予約を除外して返却

### 7.3 使用するAPI

| エンドポイント | メソッド | 用途 |
|---------------|---------|------|
| `/patients?q={phone}` | GET | 患者検索 |
| `/patients/:id` | GET | 患者詳細・予約履歴取得 |
| `/reservations/:id` | GET | 予約詳細取得 |

### 7.4 Vueコンポーネント: SideMain（検索機能）

| プロパティ/メソッド | 説明 |
|-------------------|------|
| `s_q` | 検索クエリ文字列 |
| `clickSearch()` | 患者検索を実行（s_qの値で検索） |

### 7.5 データ構造: PatientSearchItem（患者検索結果）

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `id` | 患者ID | 10000001 |
| `patient_number` | 患者番号（診察券番号） | "001" |
| `name` | 患者名 | "山田 太郎" |
| `name_kana` | 患者名フリガナ | "ヤマダ タロウ" |
| `birthday` | 生年月日 | "1990-01-01" |
| `tel1` | 電話番号1（主） | "09012345678" |
| `tel2` | 電話番号2（副） | "0312345678" |
| `mail` | メールアドレス | "user@example.com" |

### 7.6 データ構造: ReservationHistoryItem（予約履歴）

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `id` | 予約ID | 12345678 |
| `reservation_date` | 予約日 | "2026-01-27" |
| `time_from` | 開始時刻 | "09:00" |
| `time_to` | 終了時刻 | "09:30" |
| `treatment_id` | 診療メニューID | 100001 |
| `color` | 表示色 | "#c6f605" |
| `cancel_type` | キャンセル種別 | null |

### 7.7 出力情報

| フィールド | 説明 | 形式 |
|-----------|------|------|
| appointId | 予約ID | 文字列 |
| date | 日付 | YYYY-MM-DD |
| time | 時刻 | HH:MM |
| customerName | 顧客名（フリガナ優先） | 文字列 |
| customerPhone | 電話番号 | 文字列 |
| staffId | スタッフID（column_no） | 文字列 |

---

## 7. エラーコード一覧

| コード | 説明 | 発生条件 |
|--------|------|----------|
| `AUTH_FAILED` | 認証エラー | ログイン失敗時 |
| `TIMEOUT` | タイムアウト | 操作が時間内に完了しなかった場合 |
| `NOT_FOUND` | 予約が見つからない | 対象予約が存在しない場合 |
| `CONFLICT` | 予約重複 | 同一時間帯に既存予約がある場合 |

---

## 8. スクリーンショット

各処理段階でスクリーンショットを保存します。

| タイミング | ファイル名パターン | 用途 |
|-----------|-------------------|------|
| ログイン前 | `login_before.png` | ログイン画面の確認 |
| ログイン後 | `login_after.png` | ログイン成功の確認 |
| 予約作成前 | `create_before.png` | 予約フォームの確認 |
| 予約作成後 | `create_after.png` | 予約完了の確認 |
| エラー発生時 | `error_{timestamp}.png` | エラー状況の記録 |

---

## 9. 関連資料

- [Page Objects](../src/pages/) - RPA処理の実装
  - `LoginPage.ts` - ログイン処理
  - `AppointPage.ts` - アポイント管理台帳操作
- [テスト](../test/) - 統合テスト
